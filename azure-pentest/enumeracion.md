# Enumeración

## Enumeración de Dominios

Existen algunas APIs públicas de Azure que sólo conociendo el dominio del tenant un atacante podría consultar para recabar más información sobre el mismo.

<figure><img src="../.gitbook/assets/image (5) (5).png" alt=""><figcaption></figcaption></figure>

A parte de utilizar google dorks y consultas con dns se puede usar lo siguiente:

{% content-ref url="../method/recon/subdominios.md" %}
[subdominios.md](../method/recon/subdominios.md)
{% endcontent-ref %}

### Estructura de nombre de dominio de Azure Web Sites

<figure><img src="../.gitbook/assets/image (8) (1) (2).png" alt=""><figcaption></figcaption></figure>

{% embed url="https://www.netspi.com/blog/technical/cloud-penetration-testing/enumerating-azure-services/" %}

| Domain                      | Associated Service        |
| --------------------------- | ------------------------- |
| azurewebsites.net           | App Services              |
| scm.azurewebsites.net       | App Services – Management |
| p.azurewebsites.net         | App Services              |
| cloudapp.net                | App Services              |
| file.core.windows.net       | Storage Accounts-Files    |
| blob.core.windows.net       | Storage Accounts-Blobs    |
| queue.core.windows.net      | Storage Accounts-Queues   |
| table.core.windows.net      | Storage Accounts-Tables   |
| redis.cache.windows.net     | Databases-Redis           |
| documents.azure.com         | Databases-Cosmos DB       |
| database.windows.net        | Databases-MSSQL           |
| vault.azure.net             | Key Vaults                |
| onmicrosoft.com             | Microsoft Hosted Domain   |
| mail.protection.outlook.com | Email                     |
| sharepoint.com              | SharePoint                |
| azureedge.net               | CDN                       |
| search.windows.net          | Search Appliance          |
| azure-api.net               | API Services              |

Con la herramienta dig se tiene que ver que resuelva a algún dominio de Azure o 365

<figure><img src="../.gitbook/assets/image (5) (1) (2).png" alt=""><figcaption></figcaption></figure>

### Rangos de IP de Azure

<figure><img src="../.gitbook/assets/image (27) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% embed url="https://www.microsoft.com/en-us/download/details.aspx?id=56519" %}

Sabiendo el dominio es perteneciente a Azure Tenant, se puede ocupar lo siguiente:

### Manual Tenant ID

{% code overflow="wrap" %}
```
https://login.microsoftonline.com/<Domain_To_Audit><.onmicrosoft>.com/.well-known/openid-configuration
```
{% endcode %}

<figure><img src="../.gitbook/assets/image (1) (2) (2).png" alt=""><figcaption></figcaption></figure>

{% code overflow="wrap" %}
```
https://login.microsoftonline.com/getuserrealm.srf?login=auditor@atomic-nuclear.site&xml=1
```
{% endcode %}

{% code overflow="wrap" %}
```
https://login.microsoftonline.com/atomic-nuclear.site/.well-known/openid-configuration
```
{% endcode %}

<table><thead><tr><th width="239.66666666666666">API</th><th>Information</th><th>AADInternals function</th></tr></thead><tbody><tr><td>login.microsoftonline.com/&#x3C;domain>/.well-known/openid-configuration</td><td><strong>Login information</strong>, including tenant ID</td><td><code>Get-AADIntTenantID -Domain &#x3C;domain></code></td></tr><tr><td>autodiscover-s.outlook.com/autodiscover/autodiscover.svc</td><td><strong>All domains</strong> of the tenant</td><td><code>Get-AADIntTenantDomains -Domain &#x3C;domain></code></td></tr><tr><td>login.microsoftonline.com/GetUserRealm.srf?login=&#x3C;UserName></td><td><strong>Login information</strong> of the tenant, including tenant Name and domain <strong>authentication type</strong></td><td><code>Get-AADIntLoginInformation -UserName &#x3C;UserName></code></td></tr><tr><td>login.microsoftonline.com/common/GetCredentialType</td><td>Login information, including <strong>Desktop SSO information</strong></td><td><code>Get-AADIntLoginInformation -UserName &#x3C;UserName></code></td></tr></tbody></table>

### Tool AADInternals - Tenant id

También se pueden usar la herramienta [<mark style="color:green;">**AADInternals**</mark>](https://github.com/Gerenios/AADInternals) para enumerar rápidamente los dominios:

```powershell
Invoke-AADIntReconAsOutsider -DomainName some.onmicrosoft.com | Format-Table
```

Salida de ejemplo:

```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          05aea22e-32f3-4c35-831b-52735704feb3
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```

Otra función de AADinternals para obtener solo el Tenant ID es:

```powershell
Get-AADIntTenantID -Domain some.onmicrosoft.com
```

## Enumeración de Usuarios

Por medio de la herramienta [<mark style="color:green;">**AADInternals**</mark>](https://github.com/Gerenios/AADInternals) se puede

{% code overflow="wrap" %}
```powershell
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
{% endcode %}

Listar información de los correos válidos:

```powershell
Get-AADIntLoginInformation -UserName "user@company.com"
```

Además de uso de herramienta, existen otros 3 metodos de enumeración de usuarios:

<table><thead><tr><th width="149.5">Método</th><th>Descripción</th></tr></thead><tbody><tr><td>Normal</td><td>Hace referencia a la API GetCredentialType mencionada anteriormente. El método por defecto.</td></tr><tr><td>Login</td><td>Este método intenta iniciar sesión como usuario. Nota: las consultas se registrarán en el registro de inicio de sesión.</td></tr><tr><td>Autologon</td><td><p>Este método intenta iniciar sesión como el usuario a través de autologon endpoint.</p><p><mark style="color:green;"><strong>Las consultas no se registran en el registro de inicio de sesión</strong></mark>. Como tal, funciona bien para los ataques de password spray y de fuerza bruta.</p></td></tr></tbody></table>

Otra herramienta para enumeración es [<mark style="color:green;">**o365screeper**</mark>](https://github.com/LMGsec/o365creeper):

```powershell
# Poner los correos en el archivo emails.txt
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
