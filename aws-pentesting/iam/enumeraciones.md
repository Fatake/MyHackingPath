# Enumeraciones

{% hint style="warning" %}
Los siguientes comandos dependen de permisos del servicio IAM
{% endhint %}

## Enumeración de usuarios

Listado de todos los usuarios.

```bash
aws iam list-users
```

<figure><img src="../../.gitbook/assets/image (5) (6).png" alt=""><figcaption></figcaption></figure>



Listado de todos los grupos de un usuario en específico.

```bash
aws iam list-groups-for-user --user-name <Usuario>
```

<figure><img src="../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>



### Certificados

Información sobre las claves públicas SSH asociadas al usuario específico.

```bash
aws iam list-ssh-public-keys --user-name <Usuario>
```

<figure><img src="../../.gitbook/assets/image (7) (3).png" alt=""><figcaption></figcaption></figure>



Comando que devuelve información sobre una llave pública SSH específica asociada al usuario especificado.

{% code overflow="wrap" %}
```bash
aws iam get-ssh-public-key --user-name <Usuario> -- encoding PEM --ssh-public-key-id <ID-SSH-Key>
```
{% endcode %}

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>



Comando para ver información sobre los certificados de firma asociados con el usuarios especificado.

```
aws iam list-signing-certificates --user-name <User>
```

<figure><img src="../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>



### Dispositivos MFA

Listado de los dispositivos MFA(Multi-Factor Authentication) virtuales definidos en la cuenta de AWS

```
aws iam list-virtual-mfa-devices
```

<figure><img src="../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>



### Políticas del usuario

Listado de políticas adjuntas al usuario

```bash
aws iam list-attached-user-policies --user-name <User>
```

<figure><img src="../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>



Listado de políticas en formato simple asociadas al usuario // Políticas en línea insertadas (embed to one user)&#x20;

```bash
aws iam list-user-policies --user-name <User>
```

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>



## Enumeración de grupos

Enumera todos los grupos

```bash
aws iam list-groups
```

<figure><img src="../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>



### Políticas del grupo



Listado de todas las políticas asociadas a un grupo en específico

```
aws iam list-attached-group-policies --group-name <Group>
```

<figure><img src="../../.gitbook/assets/image (17) (1).png" alt=""><figcaption></figcaption></figure>



Listado de políticas en formato simple asociadas al grupo // Políticas en línea insertadas (embed to one group)&#x20;

```
aws iam list-group-policies --group-name <Group>
```

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>



## Enumeración de Roles

Listado de todos los roles de IAM

```bash
aws iam list-roles
```

<figure><img src="../../.gitbook/assets/image (4) (5).png" alt=""><figcaption></figcaption></figure>



Comando que devuelve información sobre el rol específico

```bash
aws iam get-role --role-name <Rol>
```

<figure><img src="../../.gitbook/assets/image (20).png" alt=""><figcaption></figcaption></figure>



### Políticas del rol

Lista todas las políticas gestionadas que se adjuntan al rol

```bash
aws iam list-attached-role-policies --role-name <Rol>
```

<figure><img src="../../.gitbook/assets/image (10) (1).png" alt=""><figcaption></figcaption></figure>





Listado de políticas en formato simple asociadas al rol// Políticas en línea insertadas (embed to one rol)&#x20;

```
aws iam list-role-policies --role-name <Rol>
```

<figure><img src="../../.gitbook/assets/image (21).png" alt=""><figcaption></figcaption></figure>



## Enumeración de políticas

Lista todas las políticas

```
aws iam list-policies
```

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>



Información específica de una política

```
aws iam get-policy --policy-arn <ARN-Policy>
```

<figure><img src="../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>



### Versiones de políticas

Versión de la política

```bash
aws iam list-policy-versions --policy-arn <ARN-Policy>
```

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>



Información detallada de la versión de política

{% code overflow="wrap" %}
```bash
aws iam get-policy-version --policy-arn <ARN-Policy> --version-id <VersionID>
```
{% endcode %}

<figure><img src="../../.gitbook/assets/image (31).png" alt=""><figcaption></figcaption></figure>

## Otros comandos

```bash
# All IAMs
## Retrieves  information about all IAM users, groups, roles, and policies
## in your Amazon Web Services account, including their relationships  to
## one another. Use this operation to obtain a snapshot of the configura-
## tion of IAM permissions (users, groups, roles, and  policies)  in  your
## account.
aws iam get-account-authorization-details

# List users
aws iam list-users
aws iam list-ssh-public-keys #User keys for CodeCommit
aws iam get-ssh-public-key --user-name <username> --ssh-public-key-id <id> --encoding SSH #Get public key with metadata
aws iam list-service-specific-credentials #Get special permissions of the IAM user over specific services
aws iam get-user --user-name <username> #Get metadata of user, included permissions boundaries
aws iam list-access-keys #List created access keys
## inline policies
aws iam list-user-policies --user-name <username> #Get inline policies of the user
aws iam get-user-policy --user-name <username> --policy-name <policyname> #Get inline policy details
## attached policies
aws iam list-attached-user-policies --user-name <username> #Get policies of user, it doesn't get inline policies

# List groups
aws iam list-groups #Get groups
aws iam list-groups-for-user --user-name <username> #Get groups of a user
aws iam get-group --group-name <name> #Get group name info
## inline policies
aws iam list-group-policies --group-name <username> #Get inline policies of the group
aws iam get-group-policy --group-name <username> --policy-name <policyname> #Get an inline policy info
## attached policies
aws iam list-attached-group-policies --group-name <name> #Get policies of group, it doesn't get inline policies

# List roles
aws iam list-roles #Get roles
aws iam get-role --role-name <role-name> #Get role

## inline policies
aws iam list-role-policies --role-name <name> #Get inline policies of a role
aws iam get-role-policy --role-name <name> --policy-name <name> #Get inline policy details
aws iam list-attached-role-policies --role-name <role-name> #Get policies of role, it doesn't get inline policies

# List policies
aws iam list-policies [--only-attached] [--scope Local]
aws iam list-policies-granting-service-access --arn <identity> --service-namespaces <svc> # Get list of policies that give access to the user to the service
## Get policy content
aws iam get-policy --policy-arn <policy_arn>
aws iam list-policy-versions --policy-arn <arn>
aws iam get-policy-version --policy-arn <arn:aws:iam::975426262029:policy/list_apigateways> --version-id <VERSION_X>

# Enumerate providers
aws iam list-saml-providers
aws iam get-saml-provider --saml-provider-arn <ARN>
aws iam list-open-id-connect-providers
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>

# Password Policy
aws iam get-account-password-policy

# MFA
aws iam list-mfa-devices
aws iam list-virtual-mfa-devices
```

### Políticas del usuario

```bash
## Listar las politicas de un usuario
# 1
aws iam list-attached-user-policies --user-name <User>

## 2 Sacar la version de la política con:
aws iam list-policy-versions --policy-arn <ARN-Policy>
aws iam get-policy --policy-arn <ARN-Policy>

## 3 sacar el conenido de la política
aws iam get-policy-version --policy-arn <ARN-Policy> --version-id <VersionID>
aws iam get-user-policy --user-name <username> --policy-name <policyname>
```



## Herramientas Automatizadas

### Enumerate-iam.py

{% embed url="https://github.com/andresriancho/enumerate-iam" %}

{% code title="Instalación" overflow="wrap" %}
```bash
git clone git@github.com:andresriancho/enumerate-iam.git
cd enumerate-iam/
pip install -r requirements.txt
```
{% endcode %}

{% code title="Ejecución" overflow="wrap" %}
```bash
python3 enumerate-iam.py --access-key <A-Key> --secret-key <S-Key> [--session-token <sessionToken>] [--region <region>]
```
{% endcode %}

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

### Cliam

Herramienta de enumeración de permisos de IAM en Golang

{% embed url="https://github.com/securisec/cliam" %}

{% code title="Instalación" overflow="wrap" %}
```bash
git clone https://github.com/securisec/cliam
cd cliam/cli
make dev
```
{% endcode %}

{% code title="Ejecución" overflow="wrap" %}
```bash
./cliam [aws | azure] [subcomand] [service] {[--profile name] | --access-key-id <A-key> --secret-access-key <S-Key>}
```
{% endcode %}

<figure><img src="../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### IAMFinder

Script en python para la enumeración

{% embed url="https://github.com/prisma-cloud/IAMFinder" %}

{% code title="Instalación" overflow="wrap" %}
```
git clone https://github.com/prisma-cloud/IAMFinder.git
cd IAMFinder
pip3 install -r requirements.txt
```
{% endcode %}

Luego configurar el archivo creds.json

{% code title="creds.json" overflow="wrap" %}
```json
{
    "account1": {
        "Region": "us-west-1",
        "Active": true,
        "AccessKeyId": "",
        "SecretAccessKey": ""
    },
    "account2": {
        "Region": "us-east-1",
        "Active": false,
        "AccessKeyId": "",
        "SecretAccessKey": ""
    }
}
```
{% endcode %}

{% code title="Ejecución 1" overflow="wrap" %}
```bash
python3 iamfinder.py init
```
{% endcode %}

{% code title="Ejecución 2" overflow="wrap" %}
```bash
python3 iamfinder.py [enum_user | enum_role |...] --aws_id number
```
{% endcode %}

### Otras

{% embed url="https://github.com/WithSecureLabs/awspx" %}

{% embed url="https://github.com/salesforce/cloudsplaining" %}

{% embed url="https://github.com/nccgroup/PMapper" %}

{% embed url="https://github.com/kriko69/IAMprivesc" %}





