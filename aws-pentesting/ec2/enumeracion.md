# Enumeración

## Comandos útiles

Enumerar todas las instancias EC2 en la cuenta

```
aws ec2 describe-instances
```

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>



Obtener toda la información concerniente a una instancias específica

```
aws ec2 describe-instances --instance-ids instance-id
```

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

Información concerniente a un atributo de una instancias específica.

```
aws ec2 describe-instance-attribute --attribute userData --instance-id instance-id
```

<figure><img src="../../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

Comando que devuelve todas las instancias que tienen un perfil de IAM asociado. Devuelve el ARN asociado a cada instancia

```
aws ec2 describe-iam-instance-profile-associations
```

<figure><img src="../../.gitbook/assets/image (22).png" alt=""><figcaption></figcaption></figure>

Lista todos los grupos de seguridad configurados dentro del EC2

```
aws ec2 describe-security-groups
```

<figure><img src="../../.gitbook/assets/image (4) (2).png" alt=""><figcaption></figcaption></figure>

Comando para autorizar trafico entrante desde una IP pública

{% code overflow="wrap" %}
```
aws ec2 authorize-security-group-ingress --group-id sg- 0a4c90b45f6200f2e --protocol tcp --port 2222 --cidr 181.206.25.59/32
```
{% endcode %}

<figure><img src="../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

Este comando puede ser útil, si tenemos el permiso de ec2:AuthorizeSecurityGroupIngress y deseamos tener acceso a un servicio corriendo en un EC2.

Si deseas exponer públicamente un puerto debes especificar el CIDR en 0.0.0.0/24

### Mas comandos

{% code overflow="wrap" %}
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
  echo "Instance ID: $instanceid"
  aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
  echo ""
  echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self 

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections 

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways 

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs 
aws ec2 describe-vpc-peering-connections
```
{% endcode %}

## Referencias

{% embed url="https://awscli.amazonaws.com/v2/documentation/api/2.0.34/reference/ec2/describe-instances.html" %}

{% embed url="https://awscli.amazonaws.com/v2/documentation/api/2.0.34/reference/ec2/index.html#cli-aws-ec2" %}

{% embed url="https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum" %}

